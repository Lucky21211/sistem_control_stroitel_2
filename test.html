<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API Gateway</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .endpoint { margin: 15px 0; padding: 15px; border: 1px solid #ddd; background: white; border-radius: 8px; }
        button { margin: 5px; padding: 10px 20px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005a9e; }
        input { margin: 5px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .status { padding: 5px 10px; border-radius: 4px; margin-left: 10px; font-size: 12px; }
        .success { background: #4CAF50; color: white; }
        .error { background: #f44336; color: white; }
        .token-info { background: #ffeb3b; color: #333; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ —á–µ—Ä–µ–∑ API Gateway</h1>
    <p><strong>API Gateway:</strong> http://localhost:3000</p>
    
    <div class="endpoint">
        <h3>1. üîê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <input type="text" id="regEmail" placeholder="Email" value="user@test.ru">
        <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" value="password123">
        <input type="text" id="regName" placeholder="–ò–º—è" value="Test User">
        <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <span class="status" id="regStatus"></span>
    </div>

    <div class="endpoint">
        <h3>2. üîë –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
        <input type="text" id="loginEmail" placeholder="Email" value="user@test.ru">
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" value="password123">
        <button onclick="login()">–í–æ–π—Ç–∏</button>
        <span class="status" id="loginStatus"></span>
    </div>

    <div class="endpoint">
        <h3>3. üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω)</h3>
        <button onclick="getProfile()">–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        <span class="status" id="profileStatus"></span>
    </div>

    <div class="endpoint">
        <h3>4. üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
        <button onclick="createOrder()">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑</button>
        <span class="status" id="orderStatus"></span>
    </div>

    <div class="endpoint">
        <h3>5. üìã –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤</h3>
        <button onclick="getOrders()">–ü–æ–ª—É—á–∏—Ç—å –º–æ–∏ –∑–∞–∫–∞–∑—ã</button>
        <span class="status" id="ordersStatus"></span>
    </div>

    <div id="tokenDisplay" class="token-info" style="display: none;">
        <strong>–¢–æ–∫–µ–Ω –∞–∫—Ç–∏–≤–µ–Ω:</strong> <span id="tokenPreview"></span>
    </div>

    <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:</h3>
    <pre id="result">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API...</pre>

    <script>
    let token = '';
    const GATEWAY_URL = 'http://localhost:3000';  // API Gateway
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
    function updateTokenDisplay() {
        const tokenDisplay = document.getElementById('tokenDisplay');
        const tokenPreview = document.getElementById('tokenPreview');
        
        if (token) {
            tokenDisplay.style.display = 'block';
            tokenPreview.textContent = token.substring(0, 20) + '...';
        } else {
            tokenDisplay.style.display = 'none';
        }
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    function showResult(data, statusElement = null) {
        const resultElement = document.getElementById('result');
        resultElement.textContent = JSON.stringify(data, null, 2);
        
        if (statusElement) {
            statusElement.textContent = data.success ? '‚úÖ –£—Å–ø–µ—Ö' : '‚ùå –û—à–∏–±–∫–∞';
            statusElement.className = 'status ' + (data.success ? 'success' : 'error');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    function handleError(error, operation, statusElement = null) {
        console.error(`‚ùå ${operation} error:`, error);
        const errorData = { 
            success: false, 
            error: { 
                code: 'CLIENT_ERROR',
                message: `${operation} failed: ${error.message}`,
                details: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π'
            } 
        };
        showResult(errorData, statusElement);
    }

    // 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    async function register() {
        const statusElement = document.getElementById('regStatus');
        statusElement.textContent = '‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
        
        try {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value;
            
            const response = await fetch(`${GATEWAY_URL}/v1/auth/register`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ email, password, name })
            });
            
            const data = await response.json();
            showResult(data, statusElement);
            
        } catch (error) {
            handleError(error, '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', statusElement);
        }
    }

    // 2. –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
    async function login() {
    const statusElement = document.getElementById('loginStatus');
    statusElement.textContent = '‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
    
    try {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        const response = await fetch(`${GATEWAY_URL}/v1/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        if (data.success && data.data.token) {
            token = data.data.token;
            updateTokenDisplay();
            
            console.log('üîê –ü–û–õ–£–ß–ï–ù –¢–û–ö–ï–ù:', token);
            
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º payload —Ç–æ–∫–µ–Ω–∞
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                console.log('üìã PAYLOAD –¢–û–ö–ï–ù–ê:', payload);
                console.log('‚è∞ –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç:', new Date(payload.exp * 1000));
                console.log('üë§ UserId –≤ —Ç–æ–∫–µ–Ω–µ:', payload.userId);
                console.log('üé≠ –†–æ–ª–∏ –≤ —Ç–æ–∫–µ–Ω–µ:', payload.roles);
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', e);
            }
        }
        showResult(data, statusElement);
        
    } catch (error) {
        handleError(error, '–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É', statusElement);
    }
}

    // 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
    async function getProfile() {
        const statusElement = document.getElementById('profileStatus');
        
        if (!token) {
            alert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!');
            statusElement.textContent = '‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞';
            statusElement.className = 'status error';
            return;
        }

        console.log('üîë –û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–π —Ç–æ–∫–µ–Ω:', token);
        console.log('üì® Authorization header:', `Bearer ${token}`);
        
        statusElement.textContent = '‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
        
        try {
            const response = await fetch(`${GATEWAY_URL}/v1/profile`, {
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });
            
            const data = await response.json();
            showResult(data, statusElement);
            
        } catch (error) {
            handleError(error, '–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è', statusElement);
        }
    }

    // 4. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    async function createOrder() {
        const statusElement = document.getElementById('orderStatus');
        
        if (!token) {
            alert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!');
            statusElement.textContent = '‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞';
            statusElement.className = 'status error';
            return;
        }
        
        statusElement.textContent = '‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
        
        try {
            const response = await fetch(`${GATEWAY_URL}/v1/orders`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    items: [
                        { product: "–ö–∏—Ä–ø–∏—á", quantity: 100, price: 50 },
                        { product: "–¶–µ–º–µ–Ω—Ç", quantity: 10, price: 300 },
                        { product: "–ü–µ—Å–æ–∫", quantity: 5, price: 200 }
                    ],
                    total: 7000
                })
            });
            
            const data = await response.json();
            showResult(data, statusElement);
            
        } catch (error) {
            handleError(error, '–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞', statusElement);
        }
    }

    // 5. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤
    async function getOrders() {
        const statusElement = document.getElementById('ordersStatus');
        
        if (!token) {
            alert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!');
            statusElement.textContent = '‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞';
            statusElement.className = 'status error';
            return;
        }
        
        statusElement.textContent = '‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
        
        try {
            const response = await fetch(`${GATEWAY_URL}/v1/orders`, {
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });
            
            const data = await response.json();
            showResult(data, statusElement);
            
        } catch (error) {
            handleError(error, '–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤', statusElement);
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        updateTokenDisplay();
    });
    </script>
</body>
</html>